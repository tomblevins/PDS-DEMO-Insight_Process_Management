<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ux_client_script">
    <sys_ux_client_script action="INSERT_OR_UPDATE">
        <includes>45cf8914eb320110f7e105a3a25228ab</includes>
        <macroponent display_value="DA Modal Ref Tree Lookup">853986491bac71500f0eda43cc4bcb43</macroponent>
        <name>Initialise Items</name>
        <preset/>
        <required_translations>[ ]</required_translations>
        <script><![CDATA[/**
 * @param {params} params
 * @param {api} params.api
 * @param {any} params.event
 * @param {any} params.imports
 * @param {ApiHelpers} params.helpers
 */
function handler({ api, event, helpers, imports }) {
	const { parseGroupTree, parseGeneralTree, parseCITree } =
		imports['global.Content Tree Utils']();
	const {
		props: {
			table,
			referenceTable,
			referenceField,
			dependentField,
			fieldType,
			currentValue,
			displayValue
		}
	} = api.context;
	const {
		treePickerConfig: { processor, targetPath = '', targetValue, queryString },
		domainID
	} = api.data.tree_picker.treePicker;
	let targetPathValue = [[]];
	if (targetPath) {
		targetPathValue = targetPath.split(';').reduce((target, source) => {
			target.push(source.split(','));
			return target;
		}, []);
	}
	let nameSuffix = 'parent';
	let type = 'child';
	const name = `${referenceTable}.${nameSuffix}`;
	const reference = `${table}.${referenceField}`;
	const chars = targetValue || '';
	const target =
		dependentField === ''
			? `${referenceTable}.undefined`
			: `${referenceTable}.${dependentField}`;
       
	const params = {
	    sysparm_processor: processor,
	    method: 'getTreeNodes',
	    sysparm_name: name,
	    sysparm_type: type,
	    sysparm_chars: chars,
	    sysparm_reference: reference,
	    sysparm_target: target,
	    sysparm_dependent_value: targetValue,
	    sysparm_domain: domainID,
	    sysparm_query: queryString || undefined
	};

	if (currentValue !== '')
		api.setState('clickedItems', {
			value: currentValue.split(','),
			displayValue: displayValue.split(',')
		});

	helpers
		.snHttp(
			'/xmlhttp.do',
			{
				method: 'POST',
				batch: false,
				body: {},
				params: params,
				headers: {
					'X-WantSessionNotificationMessages': 'true',
					'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
				}
			}
		)
		.then(async ({ response }) => {
			const xml = Object.values(response).join('');
			let treeJSON;
			if (referenceTable === 'sys_user_group') {
				treeJSON = parseGroupTree(xml);
				api.setState('treeItems', [treeJSON]);
			} else if (referenceTable === 'cmdb_ci') {
				treeJSON = await parseCITree(xml, undefined, targetValue, helpers);
				api.setState('treeItems', treeJSON);
			} else {
				treeJSON = parseGeneralTree(xml);
				api.setState('treeItems', [treeJSON]);
			}

			if (fieldType !== 'glide_list' && targetPathValue[0].length > 1) {
				api.emit('EXPAND_ON_LOAD');
			} else {
				api.setState('selectedItems', targetPathValue);
			}
		});
}
]]></script>
        <script_api_version>2.0.0</script_api_version>
        <sys_class_name>sys_ux_client_script</sys_class_name>
        <sys_created_by>TBlev1</sys_created_by>
        <sys_created_on>2023-08-07 17:21:25</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>3a390a491bac71500f0eda43cc4bcb31</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Initialise Items</sys_name>
        <sys_package display_value="Insight Process Management" source="x_snc_insight_pr_0">39bd5e9747f05510ab51f109536d431c</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Insight Process Management">39bd5e9747f05510ab51f109536d431c</sys_scope>
        <sys_update_name>sys_ux_client_script_3a390a491bac71500f0eda43cc4bcb31</sys_update_name>
        <sys_updated_by>TBlev1</sys_updated_by>
        <sys_updated_on>2023-08-07 17:21:25</sys_updated_on>
        <target>macroponent</target>
        <type>default</type>
    </sys_ux_client_script>
</record_update>
